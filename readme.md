# Ð›Ð°Ð±Ð¾Ñ€Ð°Ñ‚Ð¾Ñ€Ð½Ð°Ñ 1

Ð‘Ñ‹Ð»Ð¾ Ð¿Ñ€Ð¸Ð½ÑÑ‚Ð¾ Ñ€ÐµÑˆÐµÐ½Ð¸Ðµ ÑÐ¾Ð·Ð´Ð°Ñ‚ÑŒ Ð‘Ð” Ð½Ð°
Ð¾ÑÐ½Ð¾Ð²Ðµ [Ð½Ð°Ð±Ð¾Ñ€Ð° Ð´Ð°Ð½Ð½Ñ‹Ñ…](https://www.kaggle.com/datasets/mexwell/drug-consumption-classification) Ñ ÑÐ°Ð¹Ñ‚Ð° Kaggle.
ÐÐ°Ð±Ð¾Ñ€ Ð´Ð°Ð½Ð½Ñ‹Ñ… ÑÐ¾Ð´ÐµÑ€Ð¶Ð¸Ñ‚ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸ÑŽ Ð¾ Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÑÑ… Ð»ÑŽÐ´ÐµÐ¹ Ð¸ Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ð°Ñ… Ð¿ÑÐ¸Ñ…Ð¾Ð»Ð¾Ð³Ð¸Ñ‡ÐµÑÐºÐ¸Ñ… Ñ‚ÐµÑÑ‚Ð¾Ð².

ÐÐ° Ð¾ÑÐ½Ð¾Ð²Ðµ Ð½Ð°Ð±Ð¾Ñ€Ð° Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð±Ñ‹Ð»Ð° Ð¿Ñ€Ð¸Ð´ÑƒÐ¼Ð°Ð½Ð° Ð¼Ð¾Ð´ÐµÐ»ÑŒ Ñ‡Ð°ÑÑ‚Ð½Ð¾Ð¹ Ð½Ð°Ñ€ÐºÐ¾Ð»Ð¾Ð³Ð¸Ñ‡ÐµÑÐºÐ¾Ð¹ ÐºÐ»Ð¸Ð½Ð¸ÐºÐ¸.

# Ð¡Ñ…ÐµÐ¼Ð° Ð´Ð°Ð½Ð½Ñ‹Ñ…

Ð’ÑÐµÐ³Ð¾ Ð¿Ñ€Ð¸ÑÑƒÑ‚ÑÑ‚Ð²ÑƒÐµÑ‚ 4 ÑÑƒÑ‰Ð½Ð¾ÑÑ‚Ð¸:

- Ð²Ñ€Ð°Ñ‡Ð¸ Ð±Ð¾Ð»ÑŒÐ½Ð¸Ñ†Ñ‹
- Ð¿Ð°Ñ†Ð¸ÐµÐ½Ñ‚Ñ‹
- Ð¿ÐµÑ€ÐµÑ‡ÐµÐ½ÑŒ Ð²ÐµÑ‰ÐµÑÑ‚Ð², Ð¾Ñ‚ ÐºÐ¾Ñ‚Ð¾Ñ€Ñ‹Ñ… Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ñ‹ Ð¿Ð°Ñ†Ð¸ÐµÐ½Ñ‚Ñ‹
- Ð·Ð°Ð¿Ð¸ÑÐ¸ Ð¿Ð°Ñ†Ð¸ÐµÐ½Ñ‚Ð¾Ð² Ð½Ð° Ð¿Ñ€Ð¸ÐµÐ¼Ñ‹ Ðº Ð²Ñ€Ð°Ñ‡Ð°Ð¼

ÐÐ° Ð¾ÑÐ½Ð¾Ð²Ðµ Ð½Ð¸Ñ… ÑÑ„Ð¾Ñ€Ð¼Ð¸Ñ€Ð¾Ð²Ð°Ð½Ñ‹ 6 Ñ‚Ð°Ð±Ð»Ð¸Ñ†:

- doctors - Ð²Ñ€Ð°Ñ‡Ð¸, ÑÐ¾Ð´ÐµÑ€Ð¶Ð°Ñ‰ÑƒÑŽ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸ÑŽ Ð¾ Ð²Ñ€Ð°Ñ‡Ðµ
- patients - Ð¿Ð°Ñ†Ð¸ÐµÐ½Ñ‚Ñ‹, ÑÐ¾Ð´ÐµÑ€Ð¶Ð°Ñ‰ÑƒÑŽ Ð±Ð°Ð·Ð¾Ð²ÑƒÑŽ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸ÑŽ Ð¾ Ð¿Ð°Ñ†Ð¸ÐµÐ½Ñ‚Ðµ
- drugs - Ð²ÐµÑ‰ÐµÑÑ‚Ð²Ð°
- patients_personalities - Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ñ Ð¾ Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ðµ Ð¿ÑÐ¸Ñ…Ð¾Ð»Ð¾Ð³Ð¸Ñ‡ÐµÑÐºÐ¸Ñ… Ñ‚ÐµÑÑ‚Ð¾Ð². Ð¡Ð²ÑÐ·Ð°Ð½Ð° ÑÑ Ñ‚Ð°Ð±Ð»Ð¸Ñ†ÐµÐ¹ Ð¿Ð°Ñ†Ð¸ÐµÐ½Ñ‚Ð¾Ð² 1 : 1.
- patients_consumption - Ñ‚Ð°Ð±Ð»Ð¸Ñ†Ð° Ñ€ÐµÐ°Ð»Ð¸Ð·ÑƒÑŽÑ‰Ð°Ñ ÑÐ²ÑÐ·ÑŒ 1 : N Ð¼ÐµÐ¶Ð´Ñƒ Ð¿Ð°Ñ†Ð¸ÐµÐ½Ñ‚Ð°Ð¼Ð¸ Ð¸ Ð¿Ð¾ÑÐ»ÐµÐ´Ð½Ð¸Ð¼ ÑƒÐ¿Ð¾Ñ‚Ñ€ÐµÐ±Ð»ÐµÐ½Ð¸ÐµÐ¼ Ð²ÐµÑ‰ÐµÑÑ‚Ð², Ð¾Ð±Ð¾Ð³Ð°Ñ‰ÐµÐ½Ð½Ð°Ñ
  Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸ÐµÐ¹ Ð¾ Ð¿Ð¾ÑÐ»ÐµÐ´Ð½ÐµÐ¼ ÑƒÐ¿Ð¾Ñ‚Ñ€ÐµÐ±Ð»ÐµÐ½Ð¸Ð¸.
- patients_doctors_appointments - Ñ‚Ð°Ð±Ð»Ð¸Ñ†Ð°, Ñ€ÐµÐ°Ð»Ð¸Ð·ÑƒÑŽÑ‰Ð°Ñ ÑÐ²ÑÐ·ÑŒ N : M Ð¿Ð°Ñ†Ð¸ÐµÐ½Ñ‚Ð¾Ð² Ð¸ Ð²Ñ€Ð°Ñ‡ÐµÐ¹, Ð¾Ð±Ð¾Ð³Ð°Ñ‰ÐµÐ½Ð½Ð°Ñ Ð´Ð°Ñ‚Ð¾Ð¹ Ð¿Ð¾ÑÐµÑ‰ÐµÐ½Ð¸Ñ Ð¸
  Ñ„Ð»Ð°Ð³Ð¾Ð¼, Ð¿Ð¾ÐºÐ°Ð·Ñ‹Ð²Ð°ÑŽÑ‰Ð¸Ð¼, ÑÐ¾ÑÑ‚Ð¾ÑÐ»ÑÑ Ð»Ð¸ Ð¿Ñ€Ð¸ÐµÐ¼.

![ERD.png](lr1/ERD.png)

Ð¡ÐºÑ€Ð¸Ð¿Ñ‚ ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ñ ÑÑ…ÐµÐ¼Ñ‹ Ð‘Ð” Ð¸ Ñ‚Ð°Ð±Ð»Ð¸Ñ† - init.sql

# Ð—Ð°Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ðµ Ð´Ð°Ð½Ð½Ñ‹Ñ…

Ð”Ð»Ñ Ð±Ð¾Ð»ÑŒÑˆÐµÐ¹ Ñ€ÐµÐ°Ð»Ð¸ÑÑ‚Ð¸Ñ‡Ð½Ð¾ÑÑ‚Ð¸ Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð´Ð°Ð½Ð½Ñ‹Ðµ Ð¸Ð· Ð½Ð°Ð±Ð¾Ñ€Ð° Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð±Ñ‹Ð»Ð¸ Ð¿Ñ€ÐµÐ¾Ð±Ñ€Ð°Ð·Ð¾Ð²Ð°Ð½Ñ‹ Ð² Ñ‡ÐµÐ»Ð¾Ð²ÐµÐºÐ¾-Ñ‡Ð¸Ñ‚Ð°ÐµÐ¼Ñ‹Ðµ Ñ Ð¿Ð¾Ð¼Ð¾Ñ‰ÑŒÑŽ Ð½Ð°Ð¿Ð¸ÑÐ°Ð½Ð½Ð¾Ð³Ð¾
ÑÐºÑ€Ð¸Ð¿Ñ‚Ð° transform.py.
Ð”Ð°Ð»ÐµÐµ Ð±Ñ‹Ð» ÑÑ„Ð¾Ñ€Ð¼Ð¸Ñ€Ð¾Ð²Ð°Ð½ Ð½Ð°Ð±Ð¾Ñ€ ÑÐºÑ€Ð¸Ð¿Ñ‚Ð¾Ð² fill.ipynb Ð´Ð»Ñ Ð·Ð°Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ñ Ñ‚Ð°Ð±Ð»Ð¸Ñ† Ð´Ð°Ð½Ð½Ñ‹Ð¼Ð¸.

- doctors - ÑÑ‚Ñ€Ð¾ÐºÐ¸ ÑÐ¾ ÑÐ»ÑƒÑ‡Ð°Ð¹Ð½Ñ‹Ð¼ Ð¸Ð¼ÐµÐ½ÐµÐ¼, Ð´Ð°Ñ‚Ð¾Ð¹ Ñ€Ð¾Ð¶Ð´ÐµÐ½Ð¸Ñ (Ñ‚Ð°ÐºÐ¾Ð¹, Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð²Ñ€Ð°Ñ‡ Ð±Ñ‹Ð» Ð²Ð¾Ð·Ñ€Ð°ÑÑ‚Ð¾Ð¼ Ð¾Ñ‚ 28 Ð´Ð¾ 60 Ð»ÐµÑ‚), Ð¸Ð· Ñ€Ð°ÑÑ‡ÐµÑ‚Ð° ~ 1
  Ð²Ñ€Ð°Ñ‡ Ð½Ð° 50 Ð¿Ð°Ñ†Ð¸ÐµÐ½Ñ‚Ð¾Ð²
- drugs - Ð¿ÐµÑ€ÐµÑ‡ÐµÐ½ÑŒ, ÐºÐ¾Ñ‚Ð¾Ñ€Ñ‹Ð¹ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÑ‚ÑÑ Ð² Ð½Ð°Ð±Ð¾Ñ€Ðµ Ð´Ð°Ð½Ð½Ñ‹Ñ…
- patients - ÑÑ‚Ñ€Ð¾ÐºÐ¸ Ð¸Ð· Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼Ð¾Ð³Ð¾ Ð½Ð°Ð±Ð¾Ñ€Ð° Ð´Ð°Ð½Ð½Ñ‹Ñ… ÑÐ¾ ÑÐ»ÑƒÑ‡Ð°Ð¹Ð½Ñ‹Ð¼ Ð¸Ð¼ÐµÐ½ÐµÐ¼ Ð¸ Ð´Ð°Ñ‚Ð¾Ð¹ Ñ€Ð¾Ð¶Ð´ÐµÐ½Ð¸Ñ (ÐºÐ¾Ñ‚Ð¾Ñ€Ð°Ñ Ð¾ÑÐ½Ð¾Ð²Ð°Ð½Ð° Ð½Ð° Ð²Ð¾Ð·Ñ€Ð°ÑÑ‚Ðµ Ð¸Ð·
  Ð½Ð°Ð±Ð¾Ñ€Ð° Ð´Ð°Ð½Ð½Ñ‹Ñ…)
- patients_personalities - ÑÑ‚Ñ€Ð¾ÐºÐ¸ Ð¸Ð· Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼Ð¾Ð³Ð¾ Ð½Ð°Ð±Ð¾Ñ€Ð° Ð´Ð°Ð½Ð½Ñ‹Ñ…
- patients_consumption - Ð¾Ð´Ð½Ð° ÑÑ‚Ñ€Ð¾ÐºÐ° Ð½Ð°Ð±Ð¾Ñ€Ð° Ð´Ð°Ð½Ð½Ñ‹Ñ… Ñ€Ð°Ð·Ð±Ð¸Ð²Ð°Ð»Ð°ÑÑŒ Ð½Ð° Ð½ÐµÑÐºÐ¾Ð»ÑŒÐºÐ¾ ÑÑ‚Ñ€Ð¾Ðº - Ð¾Ð´Ð½Ð° ÑÑ‚Ñ€Ð¾ÐºÐ° Ð½Ð° ÐºÐ°Ð¶Ð´Ð¾Ðµ Ð½Ð°Ñ€ÐºÐ¾Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¾Ðµ
  Ð²ÐµÑ‰ÐµÑÑ‚Ð²Ð¾, Ð¿Ñ€Ð¸ Ñ‡ÐµÐ¼ Ð²ÐµÑ‰ÐµÑÑ‚Ð²Ð° Ñ Ð¿Ð¾ÑÐ»ÐµÐ´Ð½ÐµÐ¼ ÑƒÐ¿Ð¾Ñ‚Ñ€ÐµÐ±Ð»ÐµÐ½Ð¸ÐµÐ¼ = CL0 (Ð½Ð¸ÐºÐ¾Ð³Ð´Ð°) Ð¸Ð³Ð½Ð¾Ñ€Ð¸Ñ€Ð¾Ð²Ð°Ð»Ð¸ÑÑŒ
- patients_doctors_appointments - ÑÐ»ÑƒÑ‡Ð°Ð¹Ð½Ñ‹Ðµ Ð´Ð°Ð½Ð½Ñ‹Ðµ Ð¸Ð· Ñ€Ð°ÑÑ‡ÐµÑ‚Ð°, Ñ‡Ñ‚Ð¾ ÐºÐ»Ð¸Ð½Ð¸ÐºÐ° Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÐµÑ‚ ÑƒÐ¶Ðµ 7 Ð»ÐµÑ‚ Ñ Ð¿Ð¾Ð½ÐµÐ´ÐµÐ»ÑŒÐ½Ð¸ÐºÐ° Ð¿Ð¾ ÑÑƒÐ±Ð±Ð¾Ñ‚Ñƒ,
  ÐµÐ¶ÐµÐ´Ð½ÐµÐ²Ð½Ð¾ Ñƒ ÐºÐ°Ð¶Ð´Ð¾Ð³Ð¾ Ð²Ñ€Ð°Ñ‡Ð° Ð¼Ð¾Ð¶ÐµÑ‚ Ð±Ñ‹Ñ‚ÑŒ Ð´Ð¾ 20 Ð¿Ð°Ñ†Ð¸ÐµÐ½Ñ‚Ð¾Ð², Ð²ÑÐµÐ³Ð¾ ÐµÐ¶ÐµÐ´Ð½ÐµÐ²Ð½Ð¾ Ð² ÐºÐ»Ð¸Ð½Ð¸ÐºÐµ Ð½Ð°Ñ…Ð¾Ð´ÑÑ‚ÑÑ Ð¾Ñ‚ 5 Ð´Ð¾ 20 Ð²Ñ€Ð°Ñ‡ÐµÐ¹. ÐŸÑ€Ð¸ Ñ‡ÐµÐ¼
  Ð½Ð° ÐºÐ¾Ð½ÑÑƒÐ»ÑŒÑ‚Ð°Ñ†Ð¸Ð¸,ÐºÐ¾Ñ‚Ð¾Ñ€Ñ‹Ðµ ÑƒÐ¶Ðµ ÑÐ¾ÑÑ‚Ð¾ÑÐ»Ð¸ÑÑŒ (Ñ‚Ð¾ ÐµÑÑ‚ÑŒ Ð±Ñ‹Ð»Ð¸ Ð¿Ð¾Ð·Ð¶Ðµ Ñ‡ÐµÐ¼ ÑÐµÐ³Ð¾Ð´Ð½Ñ), Ð¿Ð°Ñ†Ð¸ÐµÐ½Ñ‚ Ð¿Ñ€Ð¸Ñ…Ð¾Ð´Ð¸Ð» Ñ Ð²ÐµÑ€Ð¾ÑÑ‚Ð½Ð¾ÑÑ‚ÑŒÑŽ Ð² ~70%.

ÐŸÐ¾ÑÐ»Ðµ Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ñ ÑÐºÑ€Ð¸Ð¿Ñ‚Ð° Ð² Ð‘Ð” Ð¾ÐºÐ°Ð·Ñ‹Ð²Ð°Ð»Ð¾ÑÑŒ Ð¾ÐºÐ¾Ð»Ð¾ 450 Ñ‚Ñ‹ÑÑÑ‡ ÑÑ‚Ñ€Ð¾Ðº ÑÑƒÐ¼Ð¼Ð°Ñ€Ð½Ð¾ (Ñ…Ð¾Ñ‚ÑŒ Ð¸ ÑÐ»ÑƒÑ‡Ð°Ð¹Ð½Ð¾Ðµ Ñ‡Ð¸ÑÐ»Ð¾, Ð½Ð¾ Ð·Ð°Ð²Ð¸ÑÑÑ‰ÐµÐµ Ð¾Ñ‚ ÐºÐ¾Ð»-Ð²Ð°
Ð¿Ð°Ñ†Ð¸ÐµÐ½Ñ‚Ð¾Ð², Ñ‚Ð¾ ÐµÑÑ‚ÑŒ ÑÑ‚Ñ€Ð¾Ðº Ð² Ð½Ð°Ð±Ð¾Ñ€Ðµ Ð´Ð°Ð½Ð½Ñ‹Ñ…).
Ð”Ð»Ñ Ð±Ð¾Ð»ÑŒÑˆÐµÐ¹ Ð½Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸ Ð½Ð° Ð‘Ð” ÑÐºÑ€Ð¸Ð¿Ñ‚ Ð±Ñ‹Ð» Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½ 5 Ñ€Ð°Ð·, Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð¸ÑÐºÑƒÑÑÑ‚Ð²ÐµÐ½Ð½Ð¾ ÑƒÐ²ÐµÐ»Ð¸Ñ‡Ð¸Ñ‚ÑŒ ÐºÐ¾Ð»-Ð²Ð¾ Ð²Ñ€Ð°Ñ‡ÐµÐ¹, Ð¿Ð°Ñ†Ð¸ÐµÐ½Ñ‚Ð¾Ð² Ð¸ Ð¸Ñ… Ð´Ð°Ð½Ð½Ñ‹Ñ…,
Ð° Ñ‚Ð°ÐºÐ¶Ðµ Ð·Ð°Ð¿Ð¸ÑÐµÐ¹ Ð½Ð° Ð¿Ñ€Ð¸Ð¼ÐµÐ¼.

# Ð—Ð°Ð¿Ñ€Ð¾ÑÑ‹

Ð‘Ñ‹Ð»Ð¸ Ð¿Ñ€Ð¸Ð´ÑƒÐ¼Ð°Ð½Ñ‹ 5 Ñ‚Ð¸Ð¿Ð¾Ð²Ñ‹Ñ… Ð·Ð°Ð¿Ñ€Ð¾ÑÐ¾Ð² Ð² Ð‘Ð”.

### Ð—Ð°Ð¿Ñ€Ð¾Ñ 1

ÐŸÐ¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ðµ Ð²ÑÐµÑ… Ð·Ð°Ð¿Ð¸ÑÐµÐ¹ Ð½Ð° Ð¿Ñ€Ð¸ÐµÐ¼ Ðº Ð¾Ð¿Ñ€ÐµÐ´ÐµÐ»ÐµÐ½Ð½Ð¾Ð¼Ñƒ Ð´Ð¾ÐºÑ‚Ð¾Ñ€Ñƒ Ð½Ð° Ð±Ð»Ð¸Ð¶Ð°Ð¹ÑˆÑƒÑŽ Ð½ÐµÐ´ÐµÐ»ÑŽ, Ð¾Ð±Ð¾Ð³Ð°Ñ‰ÐµÐ½Ð½Ñ‹Ðµ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸ÐµÐ¹ Ð¾ Ð¿Ð°Ñ†Ð¸ÐµÐ½Ñ‚Ð°Ñ…,
ÐºÐ¾Ñ‚Ð¾Ñ€Ñ‹Ðµ Ð´Ð¾Ð»Ð¶Ð½Ñ‹ Ð¿Ñ€Ð¸Ð¹Ñ‚Ð¸ Ð½Ð° Ð¿Ñ€Ð¸ÐµÐ¼.

```sql
select app.appointment_datetime,
       p.fio                                        as patient,
       p.gender,
       extract('year' from age(now(), p.birthdate)) as age
from clinic.patients_doctors_appointments app
inner join clinic.doctors d
    on d.id = app.doctor_id
inner join clinic.patients p
    on app.patient_id = p.id
where 
    d.id = :doctorId
    and appointment_datetime > now()
    and appointment_datetime < now() + interval '7 day'
order by appointment_datetime;
```

ÐŸÐ¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ðµ Ð»Ð¸Ñ‡Ð½Ð¾Ð¹ ÐºÐ°Ñ€Ñ‚Ð¾Ñ‡ÐºÐ¸ Ð¿Ð°Ñ†Ð¸ÐµÐ½Ñ‚Ð°, ÑÐ¾Ð´ÐµÑ€Ð¶Ð°Ñ‰ÐµÐ¹ Ð±Ð°Ð·Ð¾Ð²ÑƒÑŽ Ð¸ Ð¿ÑÐ¸Ñ…Ð¾Ð»Ð¾Ð³Ð¸Ñ‡ÐµÑÐºÑƒÑŽ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸ÑŽ Ð¾ Ð¿Ð°Ñ†Ð¸ÐµÐ½Ñ‚Ðµ, Ð° Ñ‚Ð°ÐºÐ¶Ðµ
Ð²ÐµÑ‰ÐµÑÑ‚Ð²Ð¾, Ð¾Ñ‚ ÐºÐ¾Ñ‚Ð¾Ñ€Ð¾Ð³Ð¾ Ð±Ð¾Ð»ÑŒÑˆÐµ Ð²ÑÐµÐ³Ð¾ Ð·Ð°Ð²Ð¸ÑÐ¸Ñ‚ Ð¿Ð°Ñ†Ð¸ÐµÐ½Ñ‚, Ñ Ð¿Ð¾ÑÐ»ÐµÐ´Ð½ÐµÐ¼ Ð²Ñ€ÐµÐ¼ÐµÐ½ÐµÐ¼ ÐµÐ³Ð¾ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ñ.

### Ð—Ð°Ð¿Ñ€Ð¾Ñ 2

```sql
select p.fio,
       p.gender,
       extract('year' from age(now(), p.birthdate)) as age,
       p.education,
       p.ethnicity,
       d.name                                       as main_addiction,
       c.usage                                      as last_usage,
       pp.impulsive,
       pp.sensation,
       pp.c_score,
       pp.e_score,
       pp.n_score,
       pp.o_score
from clinic.patients p
inner join clinic.patients_personalities pp
    on p.id = pp.patient_id
inner join clinic.patients_consumption c
          on p.id = c.patient_id
              and c.drug_id in (select distinct on(patient_id)
                                      drug_id
                                from clinic.patients_consumption
                                where patient_id = p.id
                                order by patient_id, usage desc)
inner join clinic.drugs d
    on c.drug_id = d.id
where 
    extract('year' from age(now(), p.birthdate)) > :age_min
    and extract('year' from age(now(), p.birthdate)) < :age_max
order by p.id, c.usage desc;
```

### Ð—Ð°Ð¿Ñ€Ð¾Ñ 3

ÐŸÐ¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ðµ ÐºÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð° ÐºÐ¾Ð½ÑÑƒÐ»ÑŒÑ‚Ð°Ñ†Ð¸Ð¹ Ñƒ Ð²ÑÐµÑ… Ð²Ñ€Ð°Ñ‡ÐµÐ¹ Ð·Ð° Ñ‚ÐµÐºÑƒÑ‰Ð¸Ð¹ Ð¼ÐµÑÑÑ† (Ð´Ð»Ñ Ñ€Ð°ÑÑ‡ÐµÑ‚Ð° Ð—ÐŸ ðŸ˜€)

```sql
select d.fio,
       count(*) as appointments
from clinic.patients_doctors_appointments app
inner join clinic.doctors d
    on d.id = app.doctor_id
where 
    appointment_datetime > date_trunc('month', now())::date
    and appointment_datetime < date_trunc('month', now())::date + interval '1 month'
group by d.id
order by appointments desc;
```

### Ð—Ð°Ð¿Ñ€Ð¾Ñ 4

ÐŸÐ¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ðµ Ð¾Ð±Ñ‰ÐµÐ³Ð¾ Ð¿Ñ€Ð¾Ñ†ÐµÐ½Ñ‚Ð° Ð¿Ñ€Ð¾Ð¿ÑƒÑÐºÐ° Ð¿Ñ€Ð¸ÐµÐ¼Ð¾Ð² Ñƒ ÐºÐ°Ð¶Ð´Ð¾Ð³Ð¾ Ð¿Ð°Ñ†Ð¸ÐµÐ½Ñ‚Ð°

```sql
select p.fio,
       trunc((100 * missed_app.missed_count::float / all_app.all_count):: numeric, 2) as missed_percent
from clinic.patients as p
left join (select patient_id, count(*) as missed_count
           from clinic.patients_doctors_appointments
           where 
                not is_committed
                and appointment_datetime < now()
           group by patient_id) as missed_app
                on p.id = missed_app.patient_id
left join (select patient_id, count(*) as all_count
           from clinic.patients_doctors_appointments
           where 
                appointment_datetime < now()
           group by patient_id) as all_app
                on p.id = all_app.patient_id;
```

### Ð—Ð°Ð¿Ñ€Ð¾Ñ 5

ÐŸÐ¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ðµ Ð¿Ð°Ñ†Ð¸ÐµÐ½Ñ‚Ð¾Ð², Ñ‡ÑŒÐµ Ð¿Ð¾ÑÐ»ÐµÐ´Ð½ÐµÐµ Ð¿Ð¾Ñ‚Ñ€ÐµÐ±Ð»ÐµÐ½Ð¸Ðµ Ð»ÑŽÐ±Ð¾Ð³Ð¾ Ð²ÐµÑ‰ÐµÑÑ‚Ð² Ð¼ÐµÐ½ÑŒÑˆÐµ ÐºÐ°ÐºÐ¾Ð³Ð¾-Ð»Ð¸Ð±Ð¾ (Ð´Ð»Ñ Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ðµ Ð¸Ð´ÑƒÑ‰Ð¸Ñ… Ð½Ð° Ð¿Ð¾Ð¿Ñ€Ð°Ð²ÐºÑƒ Ð¸Ð»Ð¸
Ñ€ÐµÑ†Ð¸Ð´Ð¸Ð²Ð¸ÑÑ‚Ð¾Ð²)

```sql
select p.fio
from clinic.patients p
inner join clinic.patients_personalities pp
    on p.id = pp.patient_id
inner join clinic.patients_consumption c
    on p.id = c.patient_id
group by p.id
having max(c.usage) <= :lastUsage
```

# ÐžÐ¿Ñ‚Ð¸Ð¼Ð¸Ð·Ð°Ñ†Ð¸Ñ

### Ð—Ð°Ð¿Ñ€Ð¾ÑÑ‹

Ð”Ð»Ñ Ð½Ð°Ñ‡Ð°Ð»Ð° Ð±Ñ‹Ð»Ð¾ Ñ€ÐµÑˆÐµÐ½Ð¾ Ð¾Ð¿Ñ‚Ð¸Ð¼Ð¸Ð·Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ Ð·Ð°Ð¿Ñ€Ð¾ÑÑ‹ Ðº Ð‘Ð”.

ÐŸÐµÑ€Ð²Ñ‹Ð¼ Ð±Ñ‹Ð» Ð·Ð°Ð¿Ñ€Ð¾Ñ Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ðµ Ð»Ð¸Ñ‡Ð½Ñ‹Ñ… ÐºÐ°Ñ€Ñ‚Ð¾Ñ‡ÐµÐº Ð¿Ð°Ñ†Ð¸ÐµÐ½Ñ‚Ð¾Ð² Ð¾Ð¿Ñ€ÐµÐ´ÐµÐ»ÐµÐ½Ð½Ð¾Ð³Ð¾ Ð²Ð¾Ð·Ñ€Ð°ÑÑ‚Ð° (Ð·Ð°Ð¿Ñ€Ð¾Ñ 2) ÐºÐ¾Ñ‚Ð¾Ñ€Ñ‹Ð¹ Ð·Ð°Ð½Ð¸Ð¼Ð°Ð» ~156 ms.
Ð”Ð»Ñ Ñ‚Ð¾Ð³Ð¾ Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð²Ñ‹Ð±Ñ€Ð°Ñ‚ÑŒ Ð³Ð»Ð°Ð²Ð½ÑƒÑŽ Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÑŒ Ð¿Ð°Ñ†Ð¸ÐµÐ½Ñ‚Ð° Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½ Ð¿Ð¾Ð´Ð·Ð°Ð¿Ñ€Ð¾Ñ,
ÐºÐ¾Ñ‚Ð¾Ñ€Ñ‹Ð¹ Ð² Ñ‚.Ñ‡ Ð¾Ð±ÐµÑÐ¿ÐµÑ‡Ð¸Ð²Ð°ÐµÑ‚ ÑƒÐ½Ð¸ÐºÐ°Ð»ÑŒÐ½Ð¾ÑÑ‚ÑŒ ÐºÐ°Ð¶Ð´Ð¾Ð¹ ÑÑ‚Ñ€Ð¾ÐºÐ¸ Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ð° Ð¿Ð¾ patient_id.
Ð—Ð°Ð¿Ñ€Ð¾Ñ Ð±Ñ‹Ð» Ð¿ÐµÑ€ÐµÐ¿Ð¸ÑÐ°Ð½ Ñ‚Ð°Ðº, Ñ‡Ñ‚Ð¾ ÑƒÐ½Ð¸ÐºÐ°Ð»ÑŒÐ½Ð¾ÑÑ‚ÑŒ Ð¸ Ð²Ñ‹Ð±Ð¾Ñ€ Ð³Ð»Ð°Ð²Ð½Ð¾Ð¹ Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸ Ð¿Ñ€Ð¾Ð¸ÑÑ…Ð¾Ð´Ð¸Ð» Ð½Ð° ÑƒÑ€Ð¾Ð²Ð½Ðµ Ð²ÑÐµÐ³Ð¾ Ð·Ð°Ð¿Ñ€Ð¾ÑÐ° Ñ Ð¿Ð¾Ð¼Ð¾Ñ‰ÑŒÑŽ
distinct Ð¸ order by:

```sql
select distinct
on (p.id) p.fio,
    p.gender,
    extract ('year' from age(now(), p.birthdate)) as age,
    p.education,
    p.ethnicity,
    d.name as main_addiction,
    c.usage as last_usage,
    pp.impulsive,
    pp.sensation,
    pp.c_score,
    pp.e_score,
    pp.n_score,
    pp.o_score
from clinic.patients p
inner join clinic.patients_personalities pp
    on p.id = pp.patient_id
inner join clinic.patients_consumption c
    on p.id = c.patient_id
inner join clinic.drugs d
    on c.drug_id = d.id
where 
    extract ('year' from age(now(), p.birthdate)) > :age_min 
    and extract ('year' from age(now(), p.birthdate)) < :age_max
order by p.id, c.usage desc;
```

ÑÑ‚Ð¾ Ð¿Ð¾Ð·Ð²Ð¾Ð»Ð¸Ð»Ð¾ ÑƒÑÐºÐ¾Ñ€Ð¸Ñ‚ÑŒ Ð·Ð°Ð¿Ñ€Ð¾Ñ Ð² 3 Ñ€Ð°Ð·Ð° - Ð²Ñ€ÐµÐ¼Ñ Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ñ ÑÑ‚Ð°Ð»Ð¾ ~ 49 ms.

Ð¢Ð°ÐºÐ¶Ðµ Ð·Ð°Ð¿Ñ€Ð¾Ñ Ð´Ð»Ñ Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ñ ÐºÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð° Ð¿Ñ€Ð¾Ð¿ÑƒÑÐºÐ¾Ð² Ð¿Ñ€Ð¸ÐµÐ¼Ð¾Ð² Ð¿Ð°Ñ†Ð¸ÐµÐ½Ñ‚Ð¾Ð² (Ð·Ð°Ð¿Ñ€Ð¾Ñ 4) Ð¼Ð¾Ð³ Ð±Ñ‹Ñ‚ÑŒ ÑƒÑÐºÐ¾Ñ€ÐµÐ½ Ð¿ÑƒÑ‚ÐµÐ¼ Ð²Ñ‹Ð½ÐµÑÐµÐ½Ð¸Ñ Ð¾Ð±Ñ‰ÐµÐ¹
Ñ‡Ð°ÑÑ‚Ð¸
Ð¿Ñ€Ð¸ Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ð¸ Ð²ÑÐµÑ… Ð·Ð°Ð¿Ð¸ÑÐµÐ¹ Ð´Ð¾ Ñ‚ÐµÐºÑƒÑ‰ÐµÐ¹ Ð´Ð°Ñ‚Ñ‹.
ÐžÐ±Ñ‰Ð°Ñ Ñ‡Ð°ÑÑ‚ÑŒ Ð±Ñ‹Ð»Ð° Ð²Ñ‹Ð½ÐµÑÐµÐ½Ð° Ð¿Ñ€Ð¸ Ð¿Ð¾Ð¼Ð¾Ñ‰Ð¸ ÐºÐ¾Ð½ÑÑ‚Ñ€ÑƒÐºÑ†Ð¸Ð¸ with:

```sql
with all_appointments as (select patient_id, is_committed
                          from clinic.patients_doctors_appointments
                          where appointment_datetime < now())
select p.fio,
       trunc((100 * missed_app.missed_count::float / all_app.all_count):: numeric, 2) as missed_percent
from clinic.patients as p
left join (select patient_id, count(*) as missed_count
           from all_appointments
           where 
              not is_committed
           group by patient_id) as missed_app
    on p.id = missed_app.patient_id
left join (select patient_id, count(*) as all_count
           from all_appointments
           group by patient_id) as all_app
    on p.id = all_app.patient_id;
```

ÐžÐ´Ð½Ð°ÐºÐ¾ Ð²Ð¼ÐµÑÑ‚Ð¾ ÑƒÑÐºÐ¾Ñ€ÐµÐ½Ð¸Ñ Ð±Ñ‹Ð»Ð¾ Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¾ Ð·Ð°Ð¼ÐµÐ´Ð»ÐµÐ½Ð¸Ðµ - Ñ ~500 ms Ð´Ð¾ ~690 ms.

### Ð˜Ð½Ð´ÐµÐºÑÑ‹

Ð•Ð´Ð¸Ð½ÑÑ‚Ð²ÐµÐ½Ð½Ð°Ñ Ñ‚Ð°Ð±Ð»Ð¸Ñ†Ð°, Ñ‡ÐµÐ¹ Ð¸Ð½Ð´ÐµÐºÑ Ð±Ñ‹Ð» ÑÐ¼Ñ‹ÑÐ» Ð¿Ñ€Ð¾Ð±Ð¾Ð²Ð°Ñ‚ÑŒ Ð¼ÐµÐ½ÑÑ‚ÑŒ - patients_doctors_appointments.
Ð‘Ñ‹Ð»Ð¾ Ñ€ÐµÑˆÐµÐ½Ð¾ ÑƒÐ´Ð°Ð»Ð¸Ñ‚ÑŒ Ð¿Ñ€ÐµÐ´Ñ‹Ð´ÑƒÑ‰Ð¸Ð¹ Ð¸Ð½Ð´ÐµÐºÑ Ð¸ Ð´Ð¾Ð±Ð°Ð²Ð¸Ñ‚ÑŒ Ð½Ð¾Ð²Ñ‹Ð¹ -

```sql
create index appointments_date_doctor_id_index
    on clinic.patients_doctors_appointments (doctor_id, appointment_datetime);
```

ÐšÐ¾Ñ‚Ð¾Ñ€Ñ‹Ð¹ ÑƒÑÐºÐ¾Ñ€Ð¸Ð» Ð·Ð°Ð¿Ñ€Ð¾ÑÑ‹ Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ñ Ð²ÑÐµÑ… Ð·Ð°Ð¿Ð¸ÑÐµÐ¹ Ð¾Ð¿Ñ€ÐµÐ´ÐµÐ»ÐµÐ½Ð½Ð¾Ð³Ð¾ Ð´Ð¾ÐºÑ‚Ð¾Ñ€Ð° Ð½Ð° Ð½ÐµÐ´ÐµÐ»ÑŽ Ð²Ð¿ÐµÑ€ÐµÐ´ (Ð·Ð°Ð¿Ñ€Ð¾Ñ 1)
Ð¸ ÐºÐ¾Ð»-Ð²Ð¾ Ð¿Ñ€Ð¸ÐµÐ¼Ð¾Ð² Ñƒ Ð²ÑÐµÑ… Ð´Ð¾ÐºÑ‚Ð¾Ñ€Ð¾Ð² Ð·Ð° Ð¼ÐµÑÑÑ† (Ð·Ð°Ð¿Ñ€Ð¾Ñ 3) Ñ 130ms Ð¸ 366ms Ð½Ð° 3ms Ð¸ 10ms ÑÐ¾Ð¾Ñ‚Ð²ÐµÑ‚ÑÑ‚Ð²ÐµÐ½Ð½Ð¾.
Ð’Ñ€ÐµÐ¼Ñ Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ñ Ð¾ÑÑ‚Ð°Ð»ÑŒÐ½Ñ‹Ñ… Ð·Ð°Ð¿Ñ€Ð¾ÑÐ¾Ð² Ð½Ðµ Ð¸Ð·Ð¼ÐµÐ½Ð¸Ð»Ð¾ÑÑŒ.
Ð¢Ð°ÐºÐ¶Ðµ Ð´Ð»Ñ ÑƒÑÐºÐ¾Ñ€ÐµÐ½Ð¸Ñ Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ñ Ð¿Ñ€Ð¾Ñ†ÐµÐ½Ñ‚Ð° Ð¿Ñ€Ð¾Ð¿ÑƒÑÐºÐ¾Ð² Ð¿Ñ€Ð¸ÐµÐ¼Ð¾Ð² Ñƒ Ð²ÑÐµÑ… Ð¿Ð°Ñ†Ð¸ÐµÐ½Ñ‚Ð¾Ð² (Ð·Ð°Ð¿Ñ€Ð¾Ñ 4)
Ð¿Ñ€ÐµÐ´Ñ‹Ð´ÑƒÑ‰Ð¸Ð¹ Ð¸Ð½Ð´ÐµÐºÑ Ð±Ñ‹Ð» Ð·Ð°Ð¼ÐµÐ½ÐµÐ½ Ð½Ð°

 ```sql
create index appointments_date_index
    on clinic.patients_doctors_appointments (appointment_datetime);
```

ÐžÐ´Ð½Ð°ÐºÐ¾ Ð²Ñ€ÐµÐ¼Ñ Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ñ Ð½Ðµ Ð¸Ð·Ð¼ÐµÐ½Ð¸Ð»Ð¾ÑÑŒ ÐºÐ°Ðº Ð´Ð»Ñ Ð·Ð°Ð¿Ñ€Ð¾ÑÐ¾Ð² 1 Ð¸ 3 (Ð¾Ð¶Ð¸Ð´Ð°Ð»Ð¾ÑÑŒ Ð½ÐµÐ±Ð¾Ð»ÑŒÑˆÐ¾Ðµ Ð·Ð°Ð¼ÐµÐ´Ð»ÐµÐ½Ð¸Ðµ),
Ñ‚Ð°Ðº Ð¸ Ð´Ð»Ñ 4 (Ð¾Ð¶Ð¸Ð´Ð°Ð»Ð¾ÑÑŒ ÑƒÑÐºÐ¾Ñ€ÐµÐ½Ð¸Ðµ) - Ð½Ðµ Ð¿Ð¾Ð¼ÐµÐ½ÑÐ»Ð¾ÑÑŒ.

### ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸ Ð‘Ð”

Ð‘Ñ‹Ð»Ð° Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ðµ ÐµÐ´Ð¸Ð½ÑÑ‚Ð²ÐµÐ½Ð½Ð°Ñ Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° - random_page_cost (Ð¸Ð·-Ð·Ð° Ð±Ð¾Ð»ÑŒÑˆÐ¾Ð¹ Ð¿Ð¾Ð¿ÑƒÐ»ÑÑ€Ð½Ð¾ÑÑ‚Ð¸ Ð² Ð¸Ð½Ñ‚ÐµÑ€Ð½ÐµÑ‚Ðµ Ð¿Ñ€Ð¸ Ð¾Ð¿Ñ‚Ð¸Ð¼Ð¸Ð·Ð°Ñ†Ð¸Ð¸),
ÐºÐ¾Ñ‚Ð¾Ñ€Ð°Ñ Ð·Ð°ÑÑ‚Ð°Ð²Ð»ÑÐµÑ‚ ÑÐ¸ÑÑ‚ÐµÐ¼Ñƒ, Ð¿Ñ€Ð¸ Ð¿Ñ€Ð¸Ð±Ð»Ð¸Ð¶ÐµÐ½Ð¸Ð¸ ÑÑ‚Ð¾Ð³Ð¾ Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸Ñ Ðº seq_page_cost = 1, Ð¿Ñ€ÐµÐ´Ð¿Ð¾Ñ‡Ð¸Ñ‚Ð°Ñ‚ÑŒ ÑÐºÐ°Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ð¿Ð¾ Ð¸Ð½Ð´ÐµÐºÑÑƒ,
Ñ‡Ñ‚Ð¾ Ð¼Ð¾Ð¶ÐµÑ‚ ÑƒÐ²ÐµÐ»Ð¸Ñ‡Ð¸Ñ‚ÑŒ Ð¿Ñ€Ð¾Ð¸Ð·Ð²Ð¾Ð´Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾ÑÑ‚ÑŒ.
ÐŸÑ€Ð¸ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ð¸ ÑÑ‚Ð¾Ð¹ Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸ Ðº ÑƒÐºÐ°Ð·Ñ‹Ð²Ð°ÐµÐ¼Ð¾Ð¼Ñƒ Ð²ÐµÐ·Ð´Ðµ Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸ÑŽ random_page_cost = 1 Ð²Ñ€ÐµÐ¼Ñ Ð¸Ð·Ð½Ð°Ñ‡Ð°Ð»ÑŒÐ½Ñ‹Ñ… Ð·Ð°Ð¿Ñ€Ð¾ÑÐ¾Ð² ÑƒÐ²ÐµÐ»Ð¸Ñ‡Ð¸Ð»Ð¾ÑÑŒ
ÑÐ»ÐµÐ´ÑƒÑŽÑ‰Ð¸Ð¼ Ð¾Ð±Ñ€Ð°Ð·Ð¾Ð¼ (Ð±ÐµÐ· Ð¿Ñ€ÐµÐ´Ñ‹Ð´ÑƒÑ‰Ð¸Ñ… Ð¾Ð¿Ñ‚Ð¸Ð¼Ð¸Ð·Ð°Ñ†Ð¸Ð¹):

| Ð·Ð°Ð¿Ñ€Ð¾Ñ | Ð±Ñ‹Ð»Ð¾, ms | ÑÑ‚Ð°Ð»Ð¾, ms     |
|--------|----------|---------------|
| 1      | 134      | 115           |
| 2      | 156      | 106           |
| 3      | 366      | Ð½Ðµ Ð¿Ð¾Ð¼ÐµÐ½ÑÐ»Ð¾ÑÑŒ |
| 4      | 512      | 480           |
| 5      | 33       | 25            |

### Ð˜Ñ‚Ð¾Ð³

Ð’ Ð¸Ñ‚Ð¾Ð³Ðµ, Ð¿Ð¾ÑÐ»Ðµ Ð²ÑÐµÑ… ÑƒÐ´Ð°Ñ‡Ð½Ñ‹Ñ… Ð¾Ð¿Ñ‚Ð¸Ð¼Ð¸Ð·Ð°Ñ†Ð¸Ð¹, Ð²Ñ€ÐµÐ¼Ñ Ð·Ð°Ð¿Ñ€Ð¾ÑÐ¾Ð² ÑÑ‚Ð°Ð»Ð¾ ÑÐ»ÐµÐ´ÑƒÑŽÑ‰Ð¸Ð¼

| Ð·Ð°Ð¿Ñ€Ð¾Ñ | Ð±Ñ‹Ð»Ð¾, ms | ÑÑ‚Ð°Ð»Ð¾, ms |
|--------|----------|-----------|
| 1      | 134      | 3         |
| 2      | 156      | 49        |
| 3      | 366      | 10        |
| 4      | 512      | 480       |
| 5      | 33       | 25        |


# Ð›Ð°Ð±Ð¾Ñ€Ð°Ñ‚Ð¾Ñ€Ð½Ð°Ñ 2
Ð’ ÐºÐ°Ñ‡ÐµÑÑ‚Ð²Ðµ Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð´Ð»Ñ Ð¾Ð±ÑƒÑ‡ÐµÐ½Ð¸Ñ Ð¼Ð¾Ð´ÐµÐ»Ð¸ Ð¼Ð°ÑˆÐ¸Ð½Ð½Ð¾Ð³Ð¾ Ð¾Ð±ÑƒÑ‡ÐµÐ½Ð¸Ñ Ð±Ñ‹Ð»Ð¸ Ð²Ñ‹Ð±Ñ€Ð°Ð½Ñ‹ Ð´Ð°Ð½Ð½Ñ‹Ðµ Ð¸Ð· Ð‘Ð” Ð¿ÐµÑ€Ð²Ð¾Ð¹ Ð›Ð . ÐœÐ¾Ð´ÐµÐ»ÑŒ, ÐºÐ¾Ñ‚Ð¾Ñ€Ð°Ñ Ð±ÑƒÐ´ÐµÑ‚ Ð¿Ð¾ÑÑ‚Ñ€Ð¾ÐµÐ½Ð° 
Ð´Ð¾Ð»Ð¶Ð½Ð° Ð¾Ñ†ÐµÐ½Ð¸Ð²Ð°Ñ‚ÑŒ Ð²ÐµÑ€Ð¾ÑÑ‚Ð½Ð¾ÑÑ‚ÑŒ ÑƒÐ¿Ð¾Ñ‚Ñ€ÐµÐ±Ð»ÐµÐ½Ð¸Ñ ÐºÐ°ÐºÐ¾Ð³Ð¾-Ð»Ð¸Ð±Ð¾ Ð²Ð¸Ð´Ð° Ð½Ð°Ñ€ÐºÐ¾Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸Ñ… Ð²ÐµÑ‰ÐµÑÑ‚Ð² Ð½Ð° Ð¾ÑÐ½Ð¾Ð²Ðµ Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð¾ Ð¿Ð°Ñ†Ð¸ÐµÐ½Ñ‚Ðµ.

### Ð”Ð°Ð½Ð½Ñ‹Ðµ
Ð”Ð»Ñ Ð¾Ñ†ÐµÐ½ÐºÐ¸ Ð²ÐµÑ€Ð¾ÑÑ‚Ð½Ð¾ÑÑ‚Ð¸ ÑƒÐ¿Ð¾Ñ‚Ñ€ÐµÐ±Ð»ÐµÐ½Ð¸Ñ Ñ‡ÐµÐ»Ð¾Ð²ÐµÐºÐ¾Ð¼ ÐºÐ°ÐºÐ¾Ð³Ð¾-Ð»Ð¸Ð±Ð¾ Ð²ÐµÑ‰ÐµÑÑ‚Ð²Ð° Ð±Ñ‹Ð»Ð¾ Ð²Ñ‹Ð±Ñ€Ð°Ð½Ð¾ "LSD", Ð¿Ð¾ÑÐºÐ¾Ð»ÑŒÐºÑƒ Ð¿Ñ€Ð¸Ð¼ÐµÑ€Ð½Ð¾ Ð¿Ð¾Ð»Ð¾Ð²Ð¸Ð½Ð° Ð¿Ð°Ñ†Ð¸ÐµÐ½Ñ‚Ð¾Ð²
Ð¸Ð· Ð‘Ð” Ñ…Ð¾Ñ‚Ñ Ð±Ñ‹ Ñ€Ð°Ð· ÑƒÐ¿Ð¾Ñ‚Ñ€ÐµÐ±Ð»ÑÐ»Ð¸ ÐµÐ³Ð¾, Ð° Ð¿Ð¾Ð»Ð¾Ð²Ð¸Ð½Ð° - Ð½ÐµÑ‚ (Ñ‡Ñ‚Ð¾ Ð¿Ð¾Ð·Ð²Ð¾Ð»Ð¸Ñ‚ Ð½Ðµ Ð±Ð°Ð»Ð°Ð½ÑÐ¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ Ð½Ð°Ð±Ð¾Ñ€ Ð´Ð°Ð½Ð½Ñ‹Ñ…).
(Ð”Ð»Ñ Ð¿Ð¾Ð½Ð¸Ð¼Ð°Ð½Ð¸Ñ ÐºÐ°ÐºÐ°Ñ Ð´Ð¾Ð»Ñ Ð¿Ð°Ñ†Ð¸ÐµÐ½Ñ‚Ð¾Ð² ÐºÐ¾Ð³Ð´Ð°-Ð»Ð¸Ð±Ð¾ ÑƒÐ¿Ð¾Ñ‚Ñ€ÐµÐ±Ð»ÑÐ»Ð¸ ÐºÐ°ÐºÐ¾Ðµ-Ð»Ð¸Ð±Ð¾ Ð²ÐµÑ‰ÐµÑÑ‚Ð²Ð¾ Ð±Ñ‹Ð» Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½ Ð·Ð°Ð¿Ñ€Ð¾Ñ:
```sql
select name, count(*) from clinic.patients_consumption
inner join clinic.drugs
    on drug_id = drugs.id
group by name
```
).
Ð”Ð»Ñ Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ñ Ð²ÑÐµÑ… Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð¾ Ð¿Ð°Ñ†Ð¸ÐµÐ½Ñ‚Ðµ, Ð° Ñ‚Ð°ÐºÐ¶Ðµ Ñ„Ð°ÐºÑ‚Ð° Ñ‚Ð¾Ð³Ð¾, 
ÑƒÐ¿Ð¾Ñ‚Ñ€ÐµÐ±Ð»ÑÐ» Ð»Ð¸ Ñ‡ÐµÐ»Ð¾Ð²ÐµÐº Ð²Ñ‹Ð±Ñ€Ð°Ð½Ð½Ð¾Ðµ Ð²ÐµÑ‰ÐµÑÑ‚Ð²Ð¾ Ñ…Ð¾Ñ‚ÑŒ Ñ€Ð°Ð· Ð±Ñ‹Ð» Ð¿Ð¾ÑÑ‚Ñ€Ð¾ÐµÐ½ ÑÐ»ÐµÐ´ÑƒÑŽÑ‰Ð¸Ð¹ Ð·Ð°Ð¿Ñ€Ð¾Ñ:

```sql
select p.gender,
       extract('year' from age(now(), p.birthdate)) as age,
       p.education,
       p.ethnicity,
       pp.impulsive,
       pp.sensation,
       pp.c_score,
       pp.e_score,
       pp.n_score,
       pp.o_score,
       c is not null                                as was_addicted
from clinic.patients p
inner join clinic.patients_personalities pp
    on p.id = pp.patient_id
left join clinic.patients_consumption c
    on c.patient_id = p.id
    and c.drug_id in (select id
                      from clinic.drugs
                      where name = 'LSD')
```

Ð ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚ Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ñ Ð·Ð°Ð¿Ñ€Ð¾ÑÐ° ÑÐºÑÐ¿Ð¾Ñ€Ñ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½ Ð² dataset.csv.

Ð”Ð°Ð»ÐµÐµ Ð±Ñ‹Ð»Ð¾ Ð½ÐµÐ¾Ð±Ñ…Ð¾Ð´Ð¸Ð¼Ð¾ Ð·Ð°Ð³Ñ€ÑƒÐ·Ð¸Ñ‚ÑŒ
```python
dataset = pd.read_csv('dataset.csv', delimiter=';')
```
Ð¸ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚Ð°Ñ‚ÑŒ Ð´Ð°Ð½Ð½Ñ‹Ðµ:
1. Ð—Ð°ÐºÐ¾Ð´Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ ÑÑ‚Ð½Ð¾Ñ, Ð¿Ñ€ÐµÐ´ÑÑ‚Ð°Ð²Ð»ÐµÐ½Ð½Ñ‹Ð¹ ÑÑ‚Ñ€Ð¾ÐºÐ¾Ð¹ Ð¸ Ð¿Ð¾Ð», Ð¿Ñ€ÐµÐ´ÑÑ‚Ð°Ð²Ð»ÐµÐ½Ð½Ñ‹Ð¹ Ð±ÑƒÐ»ÐµÐ²Ñ‹Ð¼ Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸ÐµÐ¼
```python
dataset['ethnicity'] = dataset['ethnicity'].astype('category').cat.codes.to_numpy()
dataset['gender'] = dataset['gender'] * 2 - 1
```
2. Ð Ð°Ð·Ð±Ð¸Ñ‚ÑŒ Ð´Ð°Ð½Ð½Ñ‹Ðµ Ð½Ð° Ð²Ñ…Ð¾Ð´Ð½Ñ‹Ðµ Ð¸ Ñ†ÐµÐ»ÐµÐ²Ñ‹Ðµ Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸Ñ, Ð° Ñ‚Ð°ÐºÐ¶Ðµ Ð¿Ñ€Ð¸Ð²ÐµÑÑ‚Ð¸ Ñ†ÐµÐ»ÐµÐ²Ð¾Ðµ Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸Ðµ Ð² Ð²Ð¸Ð´Ðµ Ð²ÐµÑ€Ð¾ÑÑ‚Ð½Ð¾ÑÑ‚ÐµÐ¹
```python
x = dataset.drop(columns=['was_addicted'], inplace=False).to_numpy()
y = dataset['was_addicted'].to_numpy() * 1
```
3. Ð Ð°Ð·Ð´ÐµÐ»Ð¸Ñ‚ÑŒ Ð²Ñ‹Ð±Ð¾Ñ€ÐºÑƒ Ð½Ð° Ð¾Ð±ÑƒÑ‡Ð°ÑŽÑ‰ÑƒÑŽ Ð¸ Ñ‚ÐµÑÑ‚Ð¾Ð²ÑƒÑŽ
```python
train_x, test_x, train_y, test_y = sklearn.model_selection.train_test_split(x, y, test_size=0.33, random_state=123)
```
4. ÐÐ¾Ñ€Ð¼Ð°Ð»Ð¸Ð·Ð¾Ð²Ð°Ñ‚ÑŒ Ð²Ñ…Ð¾Ð´Ð½Ñ‹Ðµ Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸Ñ
```python
scaler = preprocessing.StandardScaler().fit(train_x)
preprocessed_train_x = scaler.transform(train_x)
preprocessed_test_x = scaler.transform(test_x)
```
ÐŸÐ¾ÑÐ»Ðµ Ð²ÑÐµÑ… Ð¼Ð°Ð½Ð¸Ð¿ÑƒÐ»ÑÑ†Ð¸Ð¹ Ð½Ð°Ð±Ð¾Ñ€ Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð³Ð¾Ñ‚Ð¾Ð² Ðº Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸ÑŽ Ð² Ð¾Ð±ÑƒÑ‡ÐµÐ½Ð¸Ð¸ Ð¼Ð¾Ð´ÐµÐ»Ð¸ Ð¼Ð°ÑˆÐ¸Ð½Ð½Ð¾Ð³Ð¾ Ð¾Ð±ÑƒÑ‡ÐµÐ½Ð¸Ñ.

### ÐžÐ±ÑƒÑ‡ÐµÐ½Ð¸Ðµ

Ð’ ÐºÐ°Ñ‡ÐµÑÑ‚Ð²Ðµ Ð¼Ð¾Ð´ÐµÐ»Ð¸ Ð¼Ð°ÑˆÐ¸Ð½Ð½Ð¾Ð³Ð¾ Ð¾Ð±ÑƒÑ‡ÐµÐ½Ð¸Ñ Ð²Ñ‹Ð±Ñ€Ð°Ð½ Ð¼Ð½Ð¾Ð³Ð¾ÑÐ»Ð¾Ð¹Ð½Ñ‹Ð¹ Ð¿ÐµÑ€ÑÐµÐ¿Ñ‚Ñ€Ð¾Ð½.

Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð¼Ð¾Ð´ÐµÐ»ÑŒ Ñ Ð¿Ð¾Ð»Ð½Ð¾ÑÐ²ÑÐ·Ð½Ñ‹Ð¼Ð¸ ÑÐ»Ð¾ÑÐ¼Ð¸ Ð¸ ÑÐ»Ð¾ÑÐ¼Ð¸ Ñ€ÐµÐ³ÑƒÐ»ÑÑ€Ð¸Ð·Ð°Ñ†Ð¸Ð¸ Dropout.

```python
model.add(layers.Dropout(0.25))
model.add(layers.Dense(16, activation='swish'))
model.add(layers.Dropout(0.25))
model.add(layers.Dense(32, activation='swish'))
model.add(layers.Dropout(0.25))
model.add(layers.Dense(16, activation='swish'))
model.add(layers.Dense(1, activation='sigmoid'))
model.compile(loss=keras.losses.BinaryCrossentropy(from_logits=False), optimizer=keras.optimizers.Nadam(learning_rate=0.01), metrics=[keras.metrics.AUC()])
```
Ð’ ÐºÐ°Ñ‡ÐµÑÑ‚Ð²Ðµ Ñ„ÑƒÐ½ÐºÑ†Ð¸Ð¸ Ð°ÐºÑ‚Ð¸Ð²Ð°Ñ†Ð¸Ð¸ Ð½Ð° ÑÐºÑ€Ñ‹Ñ‚Ñ‹Ñ… ÑÐ»Ð¾ÑÑ… Ð²Ñ‹Ð±Ñ€Ð°Ð½Ð° Ñ„ÑƒÐ½ÐºÑ†Ð¸Ñ swish (SiLU, ÑÐ¸Ð³Ð¼Ð¾Ð¸Ð´Ð°Ð»ÑŒÐ½Ð¾-Ð»Ð¸Ð½ÐµÐ¹Ð½Ð°Ñ Ñ„ÑƒÐ½ÐºÑ†Ð¸Ñ) Ð¸Ð·-Ð·Ð° ÑÐ²Ð¾ÐµÐ¹ ÑÑ„Ñ„ÐµÐºÑ‚Ð¸Ð²Ð½Ð¾ÑÑ‚Ð¸ (Ñ‚Ð°ÐºÐ¶Ðµ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð»Ð¸ÑÑŒ ReLU Ð¸ Leaky ReLU, Ð½Ð¾ Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚ Ñƒ Ð¼Ð¾Ð´ÐµÐ»Ð¸, Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð²ÑˆÐ¸Ñ… Ð¸Ñ…, Ð±Ñ‹Ð» Ð¿Ñ€Ð¸Ð¼ÐµÑ€Ð½Ð¾ Ð½Ð° Ð´ÐµÑÑÑ‚ÑƒÑŽ Ð´Ð¾Ð»ÑŽ Ñ…ÑƒÐ¶Ðµ).
Ð’ ÐºÐ°Ñ‡ÐµÑÑ‚Ð²Ðµ Ñ„ÑƒÐ½ÐºÑ†Ð¸Ð¸ Ð°ÐºÑ‚Ð¸Ð²Ð°Ñ†Ð¸Ð¸ Ð½Ð° Ð¿Ð¾ÑÐ»ÐµÐ´Ð½ÐµÐ¼ ÑÐ»Ð¾Ðµ Ð¸ Ñ„ÑƒÐ½ÐºÑ†Ð¸Ð¸ Ð¾ÑˆÐ¸Ð±ÐºÐ¸ Ð±Ñ‹Ð»Ð¸ Ð²Ñ‹Ð±Ñ€Ð°Ð½Ñ‹ Ñ‚Ð¸Ð¿Ð¸Ñ‡Ð½Ñ‹Ðµ Ð´Ð»Ñ Ð±Ð¸Ð½Ð°Ñ€Ð½Ð¾Ð¹ ÐºÐ»Ð°ÑÑÐ¸Ñ„Ð¸ÐºÐ°Ñ†Ð¸Ð¸ - sigmoid Ð¸ binary crossentropy.
Ð’ ÐºÐ°Ñ‡ÐµÑÑ‚Ð²Ðµ Ð¾Ð¿Ñ‚Ð¸Ð¼Ð¸Ð·Ð°Ñ‚Ð¾Ñ€Ð° Ð²Ñ‹Ð±Ñ€Ð°Ð½ Nadam (Adam Ñ Ð¼Ð¾Ð¼ÐµÐ½Ñ‚Ð¾Ð¼ ÐÐµÑÑ‚ÐµÑ€Ð¾Ð²Ð° Ð²Ð¼ÐµÑÑ‚Ð¾ Ð¾Ð±Ñ‹Ñ‡Ð½Ð¾Ð³Ð¾ Ð¼Ð¾Ð¼ÐµÐ½Ñ‚Ð°), Ð¿Ð¾ÑÐºÐ¾Ð»ÑŒÐºÑƒ Ð¿Ð¾ÐºÐ°Ð·Ð°Ð» ÑÐµÐ±Ñ Ð»ÑƒÑ‡ÑˆÐµ Ð¾ÑÑ‚Ð°Ð»ÑŒÐ½Ñ‹Ñ… Ð² ÑÐºÐ¾Ñ€Ð¾ÑÑ‚Ð¸ Ð¾Ð±ÑƒÑ‡ÐµÐ½Ð¸Ñ (Ñ€Ð°ÑÑÐ¼Ð°Ñ‚Ñ€Ð¸Ð²Ð°Ð»Ð¸ÑÑŒ Ñ‚Ð°ÐºÐ¶Ðµ Adam Ð¸ Ð¡Ð“Ð¡ Ñ Ð¼Ð¾Ð¼ÐµÐ½Ñ‚Ð¾Ð¼).
ÐœÐ¾Ð´ÐµÐ»ÑŒ Ð¾Ð±ÑƒÑ‡Ð°Ð»Ð°ÑÑŒ Ð½Ð° Ð¿Ñ€Ð¾Ñ‚ÑÐ¶ÐµÐ½Ð¸Ð¸ 15 ÑÐ¿Ð¾Ñ….

ÐŸÐ¾ÑÐ»Ðµ Ð¾Ð±ÑƒÑ‡ÐµÐ½Ð¸Ñ Ð¿Ð¾Ð»ÑƒÑ‡Ð¸Ð¼ Ð¿Ñ€ÐµÐ´ÑÐºÐ°Ð·Ð°Ð½Ð¸Ñ Ð½Ð° Ñ‚ÐµÑÑ‚Ð¾Ð²Ð¾Ð¹ Ð²Ñ‹Ð±Ð¾Ñ€ÐºÐµ, Ð¿Ð¾Ð´ÑÑ‡Ð¸Ñ‚Ð°ÐµÐ¼ Ð»ÑƒÑ‡ÑˆÐµÐµ Ð¿Ð¾Ñ€Ð¾Ð³Ð¾Ð²Ð¾Ðµ Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸Ðµ Ñ Ð¿Ð¾Ð¼Ð¾Ñ‰ÑŒÑŽ ROC ÐºÑ€Ð¸Ð²Ð¾Ð¹:
![roc.png](lr2%2Froc.png)

Ð”Ð°Ð»ÐµÐµ, Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÑ Ð»ÑƒÑ‡ÑˆÐµÐµ Ð¿Ð¾Ñ€Ð¾Ð³Ð¾Ð²Ð¾Ðµ Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸Ðµ, Ð¿Ð¾ÑÑ‡Ð¸Ñ‚Ð°ÐµÐ¼ Ð¼ÐµÑ‚Ñ€Ð¸ÐºÐ¸:
```
accuracy: 0.7287319422150883, 
precision: 0.6730769230769231, 
recall = 0.7581227436823105, 
roc auc = 0.7878800525865487
confusion matrix:
 [[244 102]
 [ 67 210]]
```

ÐŸÐ¾Ð»Ð½Ñ‹Ð¹ ÐºÐ¾Ð´ Ð¿Ñ€ÐµÐ´ÑÑ‚Ð°Ð²Ð»ÐµÐ½ Ð² learn.ipynb
